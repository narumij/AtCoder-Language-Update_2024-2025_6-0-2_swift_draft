name: Run test
run-name: ${{ github.workflow }} (${{ github.ref_name }})

on:
    push:
        branches:
            - main
            - test/**
    pull_request:
    workflow_dispatch:

concurrency:
    group: |
        test-${{
            startsWith(github.ref_name, 'test') && github.ref_name ||
            github.run_id
        }}
    cancel-in-progress: true

jobs:
    run:
        runs-on: ubuntu-24.04

        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.head_ref || github.ref_name }}
                  fetch-depth: 0

            - name: Use ccache
              uses: hendrikmuhs/ccache-action@v1.2
              with:
                  create-symlink: true
                  
            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable
            
            - name: Install tomlq
              run: cargo install tomlq
              
            - name: Query TOML 'install'
              run: |
                tq 'install' --file dist/swift.toml | sed -e "1s/^'''//" -e "\$s/'''$//"              

            - name: Query TOML 'version'
              id: get_toml_version
              run: |
                TOML_VERSION=$(tq 'version' --file dist/swift.toml | sed -e "1s/^'//" -e "\$s/'$//")
                echo "TOML_VERSION=${TOML_VERSION}" >> $GITHUB_ENV

            - name: Get installed Swift version
              id: get_installed_version
              run: |
                INSTALLED_VERSION=$(swift --version | awk '{print $4}')
                echo "INSTALLED_VERSION=${INSTALLED_VERSION}" >> $GITHUB_ENV

            - name: Check Swift version match
              run: |
                if [ "$TOML_VERSION" = "$INSTALLED_VERSION" ]; then
                  echo "Swift versions match: $TOML_VERSION"
                else
                  echo "Swift version mismatch! TOML: $TOML_VERSION, Installed: $INSTALLED_VERSION"
                  exit 1
                fi

            - name: Install
              run: |
                tq 'install' --file dist/swift.toml | sed -e "1s/^'''//" -e "\$s/'''$//" | sh               

            - name: Test
              run: |
                  chmod +x ./test/test.sh
                  ./test/test.sh
